apiVersion: batch/v1
kind: CronJob
metadata:
  name: akeyless-to-s3-exporter
  namespace: default
spec:
  # Run daily at 2 AM UTC - adjust as needed
  schedule: "0 2 * * *"

  # Keep last 3 successful and 1 failed jobs
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1

  # Concurrent policy - Forbid to prevent overlapping runs
  concurrencyPolicy: Forbid

  jobTemplate:
    spec:
      # Cleanup completed jobs after 1 hour
      ttlSecondsAfterFinished: 3600

      template:
        metadata:
          labels:
            app: akeyless-to-s3-exporter
        spec:
          restartPolicy: OnFailure

          containers:
          - name: exporter
            image: your-registry/akeyless-to-s3:latest
            imagePullPolicy: Always

            env:
            # Akeyless configuration
            - name: AKEYLESS_API_KEY
              valueFrom:
                secretKeyRef:
                  name: akeyless-credentials
                  key: api-key

            - name: AKEYLESS_GATEWAY_URL
              valueFrom:
                configMapKeyRef:
                  name: akeyless-config
                  key: gateway-url

            - name: BASE_PATH
              valueFrom:
                configMapKeyRef:
                  name: akeyless-config
                  key: base-path
                  optional: true

            # AWS S3 configuration
            - name: AWS_REGION
              valueFrom:
                configMapKeyRef:
                  name: s3-config
                  key: region

            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: access-key-id

            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-credentials
                  key: secret-access-key

            - name: S3_BUCKET
              valueFrom:
                configMapKeyRef:
                  name: s3-config
                  key: bucket

            # Logging configuration
            - name: LOG_LEVEL
              value: "info"

            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "512Mi"
                cpu: "500m"

          # Optional: Use a specific service account if needed
          # serviceAccountName: akeyless-exporter
